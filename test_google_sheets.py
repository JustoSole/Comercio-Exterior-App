#!/usr/bin/env python3
"""
Script de prueba para Google Sheets
Ejecutar despu√©s de habilitar las APIs
"""

import sys
import toml
from datetime import datetime

def test_formulas_with_upload_function():
    """Probar la nueva funci√≥n upload_to_google_sheets con f√≥rmulas autom√°ticas"""
    try:
        print("üßÆ Probando funci√≥n upload_to_google_sheets con f√≥rmulas...")
        
        # Importar m√≥dulos
        sys.path.append('.')
        from streamlit_ai_comercio_exterior import get_gspread_client, upload_to_google_sheets
        
        # Simular secrets de Streamlit
        class MockSecrets:
            def __init__(self, secrets_dict):
                self._secrets = secrets_dict
            def __getitem__(self, key):
                return self._secrets[key]
            def get(self, key, default=None):
                return self._secrets.get(key, default)
        
        import streamlit as st
        secrets = toml.load('.streamlit/secrets.toml')
        st.secrets = MockSecrets(secrets)
        
        # Crear datos de prueba simulando una cotizaci√≥n real
        test_data = {
            "fecha": datetime.now().strftime("%d/%m/%Y %H:%M:%S"),
            "producto": "Smartphone Samsung Galaxy A54 - TEST F√ìRMULAS",
            "imagen_url": "https://via.placeholder.com/150x150.png?text=Samsung+A54",
            "url_producto": "https://alibaba.com/product/test-smartphone",
            "cantidad": 50,
            "precio_unitario_fob": 180.50,
            "moneda": "USD",
            "tipo_cambio": 1250.00,
            "derechos_importacion_pct": 16,
            "tasa_estadistica_pct": 3,
            "iva_importacion_pct": 21,
            "percepcion_iva_pct": 10,
            "percepcion_ganancias_pct": 7,
            "ingresos_brutos_pct": 2.5,
            "costo_flete_unitario": 8.25,
            "honorarios_despachante": 1200,
            "ncm": "8517.12.00",
            "descripcion_ncm": "Tel√©fonos m√≥viles y dem√°s equipos de telefon√≠a m√≥vil",
            "confianza_ia": "95%",
            "peso_unitario_kg": 0.195,
            "dimensiones": "15.4 √ó 7.6 √ó 0.82 cm",
            "metodo_flete": "A√©reo Express",
            "origen": "China",
            "destino": "Argentina",
            "tipo_importador": "Habitual",
            "provincia": "Buenos Aires",
            "notas": "Producto de prueba para testing de f√≥rmulas autom√°ticas"
        }
        
        print("üìä Datos de prueba preparados:")
        print(f"  Producto: {test_data['producto']}")
        print(f"  Cantidad: {test_data['cantidad']} unidades")
        print(f"  Precio FOB: USD {test_data['precio_unitario_fob']}")
        print(f"  Tipo de cambio: ${test_data['tipo_cambio']}")
        print(f"  Impuestos: {test_data['derechos_importacion_pct']}% + {test_data['iva_importacion_pct']}% + otros")
        
        # Probar la funci√≥n upload_to_google_sheets
        print("\nüöÄ Ejecutando upload_to_google_sheets...")
        
        # Simular el contexto de Streamlit para evitar errores
        class MockStreamlit:
            def error(self, msg): print(f"ERROR: {msg}")
            def warning(self, msg): print(f"WARNING: {msg}")
            def info(self, msg): print(f"INFO: {msg}")
            def success(self, msg): print(f"SUCCESS: {msg}")
            def write(self, msg): print(f"WRITE: {msg}")
        
        st.error = MockStreamlit().error
        st.warning = MockStreamlit().warning
        st.info = MockStreamlit().info
        st.success = MockStreamlit().success
        st.write = MockStreamlit().write
        
        # Ejecutar la funci√≥n
        result = upload_to_google_sheets(test_data, "Cotizaciones APP IA")
        
        if result:
            print("\n‚úÖ ¬°√âXITO! Funci√≥n upload_to_google_sheets ejecutada correctamente")
            print("\nüßÆ VERIFICAR EN GOOGLE SHEETS:")
            print("  1. ‚úÖ Datos base cargados")
            print("  2. ‚úÖ F√≥rmulas de c√°lculo autom√°tico aplicadas")
            print("  3. ‚úÖ Status visual con emojis")
            print("  4. ‚úÖ Alertas de impuestos")
            print("  5. ‚úÖ ROI y precio de venta calculados")
            print("  6. ‚úÖ Formato de moneda aplicado")
            print("  7. ‚úÖ F√≥rmula de imagen agregada")
            
            expected_formulas = [
                "Subtotal FOB = Cantidad √ó Precio Unitario",
                "Derechos Importaci√≥n = Subtotal √ó (Porcentaje/100)", 
                "Total Impuestos = SUMA de todos los impuestos",
                "Total Landed Cost = Subtotal + Impuestos + Flete",
                "Status visual basado en el costo total",
                "ROI calculado autom√°ticamente"
            ]
            
            print("\nüìã F√ìRMULAS ESPERADAS:")
            for i, formula in enumerate(expected_formulas, 1):
                print(f"  {i}. {formula}")
            
            return True
        else:
            print("\n‚ùå Error en la funci√≥n upload_to_google_sheets")
            return False
            
    except Exception as e:
        print(f"\n‚ùå Error en test de f√≥rmulas con upload: {e}")
        import traceback
        print(f"üìã Detalles: {traceback.format_exc()}")
        return False

def test_formulas_google_sheets():
    """Probar carga de f√≥rmulas espec√≠ficas en Google Sheets"""
    try:
        print("üßÆ Probando f√≥rmulas en Google Sheets...")
        
        # Importar m√≥dulos
        sys.path.append('.')
        from streamlit_ai_comercio_exterior import get_gspread_client
        
        # Simular secrets de Streamlit
        class MockSecrets:
            def __init__(self, secrets_dict):
                self._secrets = secrets_dict
            def __getitem__(self, key):
                return self._secrets[key]
            def get(self, key, default=None):
                return self._secrets.get(key, default)
        
        import streamlit as st
        secrets = toml.load('.streamlit/secrets.toml')
        st.secrets = MockSecrets(secrets)
        
        # Conectar a Google Sheets
        gc = get_gspread_client()
        if not gc:
            print("‚ùå No se pudo crear el cliente de Google Sheets")
            return False
        
        # Usar la hoja existente en lugar de crear una nueva
        hoja_nombre = "Cotizaciones APP IA"
        try:
            sh = gc.open(hoja_nombre)
            print(f"‚úÖ Usando hoja existente '{hoja_nombre}'")
        except Exception as e:
            print(f"‚ùå Error al acceder a la hoja '{hoja_nombre}': {e}")
            return False
        
        # Crear un nuevo worksheet para las pruebas de f√≥rmulas
        try:
            # Intentar crear un nuevo worksheet dentro de la hoja existente
            worksheet = sh.add_worksheet(title="TEST F√≥rmulas", rows="100", cols="20")
            print("‚úÖ Worksheet de prueba creado")
        except Exception as ws_error:
            print(f"‚ö†Ô∏è No se pudo crear nuevo worksheet, usando el principal: {ws_error}")
            # Usar el worksheet principal y agregar datos al final
            worksheet = sh.sheet1
            
            # Encontrar la primera fila vac√≠a para no sobrescribir datos existentes
            values = worksheet.get_all_values()
            start_row = len(values) + 2  # Dejar una fila en blanco
            
            print(f"üìä Usando worksheet principal, iniciando en fila {start_row}")
        
        # 1. AGREGAR ENCABEZADOS PARA LA SECCI√ìN DE PRUEBAS
        print("üìã Agregando secci√≥n de pruebas de f√≥rmulas...")
        
        try:
            if 'start_row' in locals():
                # Estamos en el worksheet principal, agregar desde la fila calculada
                current_row = start_row
                worksheet.update(f'A{current_row}', "=== PRUEBA DE F√ìRMULAS ===")
                current_row += 1
            else:
                # Estamos en un worksheet nuevo, empezar desde la fila 1
                current_row = 1
                worksheet.clear()
            
            headers = [
                "Producto", "Cantidad", "Precio USD", "Tipo Cambio", 
                "Precio ARS", "Impuestos %", "Total Impuestos", 
                "Flete USD", "Total Landed", "Status", "Validaci√≥n"
            ]
            
            # Agregar encabezados
            for col, header in enumerate(headers, start=1):
                worksheet.update_cell(current_row, col, header)
            
            current_row += 1
            
            # 2. AGREGAR DATOS DE EJEMPLO
            print("üìä Agregando datos de ejemplo...")
            datos_ejemplo = [
                ["Smartphone Samsung", 10, 150, 1200, "", 35, "", 25, "", "", ""],
                ["Laptop Dell", 5, 800, 1200, "", 35, "", 75, "", "", ""],
                ["Tablet iPad", 8, 500, 1200, "", 35, "", 40, "", "", ""]
            ]
            
            start_data_row = current_row
            for datos in datos_ejemplo:
                for col, valor in enumerate(datos, start=1):
                    if valor != "":
                        worksheet.update_cell(current_row, col, valor)
                current_row += 1
            
            # 3. AGREGAR F√ìRMULAS DE C√ÅLCULO
            print("üí∞ Agregando f√≥rmulas de c√°lculo...")
            
            for row in range(start_data_row, start_data_row + 3):
                # Precio ARS = Precio USD * Tipo Cambio (columna E = 5)
                formula_ars = f"=C{row}*D{row}"
                worksheet.update_cell(row, 5, formula_ars)
                
                # Total Impuestos = Precio ARS * (Impuestos% / 100) (columna G = 7)
                formula_impuestos = f"=E{row}*(F{row}/100)"
                worksheet.update_cell(row, 7, formula_impuestos)
                
                # Total Landed = Precio ARS + Impuestos + (Flete USD * Tipo Cambio) (columna I = 9)
                formula_landed = f"=E{row}+G{row}+(H{row}*D{row})"
                worksheet.update_cell(row, 9, formula_landed)
                
                # Status condicional (columna J = 10)
                formula_status = f'=IF(I{row}>500000;"üî¥ ALTO";IF(I{row}>200000;"üü° MEDIO";"üü¢ BAJO"))'
                worksheet.update_cell(row, 10, formula_status)
                
                # Validaci√≥n (columna K = 11)
                formula_validacion = f'=IF(AND(B{row}>0;C{row}>0;D{row}>0);"‚úÖ";"‚ùå")'
                worksheet.update_cell(row, 11, formula_validacion)
            
            # 4. AGREGAR F√ìRMULAS DE RESUMEN
            print("üìä Agregando f√≥rmulas de resumen...")
            current_row += 1
            worksheet.update_cell(current_row, 1, "RESUMEN:")
            current_row += 1
            
            # Total cantidad
            worksheet.update_cell(current_row, 1, "Total Cantidad:")
            formula_total_cant = f"=SUM(B{start_data_row}:B{start_data_row+2})"
            worksheet.update_cell(current_row, 2, formula_total_cant)
            
            # Promedio precio USD
            worksheet.update_cell(current_row, 3, "Prom USD:")
            formula_prom_usd = f"=AVERAGE(C{start_data_row}:C{start_data_row+2})"
            worksheet.update_cell(current_row, 4, formula_prom_usd)
            
            # Total ARS
            worksheet.update_cell(current_row, 5, "Total ARS:")
            formula_total_ars = f"=SUM(E{start_data_row}:E{start_data_row+2})"
            worksheet.update_cell(current_row, 6, formula_total_ars)
            
            # Total Landed Cost
            worksheet.update_cell(current_row, 7, "Total Landed:")
            formula_total_landed = f"=SUM(I{start_data_row}:I{start_data_row+2})"
            worksheet.update_cell(current_row, 8, formula_total_landed)
            
            # 5. PRUEBA DE F√ìRMULA DE IMAGEN (si hay espacio)
            print("üñºÔ∏è Agregando f√≥rmula de imagen...")
            try:
                current_row += 2
                worksheet.update_cell(current_row, 1, "Test Imagen:")
                formula_imagen = '=IMAGE("https://via.placeholder.com/100x100.png?text=TEST")'
                worksheet.update_cell(current_row, 2, formula_imagen)
            except Exception as img_error:
                print(f"‚ö†Ô∏è No se pudo agregar imagen: {img_error}")
            
            print("‚úÖ ¬°Todas las f√≥rmulas agregadas exitosamente!")
            print(f"üìã Ver hoja con f√≥rmulas: {sh.url}")
            
            # Resumen de f√≥rmulas probadas
            formulas_probadas = [
                "‚úÖ Conversi√≥n de moneda (=C*D)",
                "‚úÖ C√°lculo de impuestos (=E*(F/100))",
                "‚úÖ Landed cost total (=E+G+(H*D))",
                "‚úÖ Condicionales IF anidadas con ;",
                "‚úÖ Validaci√≥n con AND usando ;",
                "‚úÖ Funciones SUM, AVERAGE",
                "‚úÖ F√≥rmulas IMAGE",
                "‚úÖ Formato condicional con emojis"
            ]
            
            print("\nüßÆ F√ìRMULAS PROBADAS:")
            for formula in formulas_probadas:
                print(f"  {formula}")
            
            return True
            
        except Exception as formula_error:
            print(f"‚ùå Error agregando f√≥rmulas: {formula_error}")
            import traceback
            print(f"üìã Detalles: {traceback.format_exc()}")
            return False
        
    except Exception as e:
        print(f"\n‚ùå Error en test de f√≥rmulas: {e}")
        import traceback
        print(f"üìã Detalles: {traceback.format_exc()}")
        return False

def test_google_sheets():
    """Probar conexi√≥n a Google Sheets"""
    try:
        print("üîÑ Probando conexi√≥n a Google Sheets...")
        
        # Importar m√≥dulos
        sys.path.append('.')
        from streamlit_ai_comercio_exterior import get_gspread_client
        
        # Simular secrets de Streamlit
        class MockSecrets:
            def __init__(self, secrets_dict):
                self._secrets = secrets_dict
            def __getitem__(self, key):
                return self._secrets[key]
            def get(self, key, default=None):
                return self._secrets.get(key, default)
        
        import streamlit as st
        secrets = toml.load('.streamlit/secrets.toml')
        st.secrets = MockSecrets(secrets)
        
        # Intentar conectar
        gc = get_gspread_client()
        if not gc:
            print("‚ùå No se pudo crear el cliente de Google Sheets")
            return False
            
        print("‚úÖ Cliente de Google Sheets creado")
        
        # Intentar abrir la hoja
        hoja_nombre = "Cotizaciones APP IA"
        sh = gc.open(hoja_nombre)
        print(f"‚úÖ Hoja '{hoja_nombre}' encontrada")
        print(f"üìã URL: {sh.url}")
        
        # Verificar worksheets
        worksheets = sh.worksheets()
        print(f"üìä Worksheets disponibles: {[ws.title for ws in worksheets]}")
        
        # Probar escritura
        worksheet = sh.sheet1
        print(f"‚úÖ Acceso a worksheet: {worksheet.title}")
        
        # Agregar una fila de prueba
        datos_prueba = [
            datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "PRUEBA - Conexi√≥n exitosa",
            "$100.00", 
            "8517.12.00",
            "Test autom√°tico - APIs habilitadas"
        ]
        
        worksheet.append_row(datos_prueba)
        print("‚úÖ Datos de prueba escritos exitosamente")
        
        print("\nüéâ ¬°√âXITO TOTAL! Google Sheets est√° funcionando perfectamente.")
        print(f"üëÄ Revisa tu hoja aqu√≠: {sh.url}")
        
        return True
        
    except Exception as e:
        print(f"\n‚ùå Error: {e}")
        
        if "has not been used" in str(e) or "is disabled" in str(e):
            print("\nüîß Las APIs a√∫n no est√°n habilitadas o no se han propagado.")
            print("Espera unos minutos m√°s y vuelve a intentar.")
        elif "not found" in str(e).lower():
            print(f"\nüîß No se encontr√≥ la hoja '{hoja_nombre}'")
            print("Verifica que el nombre sea exacto.")
        elif "permission" in str(e).lower():
            print(f"\nüîß La hoja no est√° compartida con el Service Account")
            print("Comparte con: b3consulting@b3consulting.iam.gserviceaccount.com")
        
        return False

def test_simple_upload():
    """Test simple para verificar upload_to_google_sheets con f√≥rmulas"""
    try:
        print("üöÄ Test simple de upload con f√≥rmulas...")
        
        # Importar m√≥dulos
        sys.path.append('.')
        from streamlit_ai_comercio_exterior import upload_to_google_sheets
        
        # Simular secrets de Streamlit
        class MockSecrets:
            def __init__(self, secrets_dict):
                self._secrets = secrets_dict
            def __getitem__(self, key):
                return self._secrets[key]
            def get(self, key, default=None):
                return self._secrets.get(key, default)
        
        import streamlit as st
        secrets = toml.load('.streamlit/secrets.toml')
        st.secrets = MockSecrets(secrets)
        
        # Mock simple de streamlit
        class MockST:
            def error(self, msg): print(f"‚ùå {msg}")
            def warning(self, msg): print(f"‚ö†Ô∏è {msg}")
            def info(self, msg): print(f"‚ÑπÔ∏è {msg}")
            def success(self, msg): print(f"‚úÖ {msg}")
            def write(self, msg): print(f"üìù {msg}")
        
        mock_st = MockST()
        st.error = mock_st.error
        st.warning = mock_st.warning
        st.info = mock_st.info
        st.success = mock_st.success
        st.write = mock_st.write
        
        # Datos m√≠nimos para test
        test_data = {
            "fecha": "29/07/2024 10:00:00",
            "producto": "TEST SIMPLE - Smartphone",
            "imagen_url": "https://via.placeholder.com/100x100.png?text=TEST",
            "url_producto": "https://test.com",
            "cantidad": 10,
            "precio_unitario_fob": 100.0,
            "moneda": "USD",
                         "tipo_cambio": 1200.0,
             "derechos_importacion_pct": 0.15,  # 15% como decimal
             "tasa_estadistica_pct": 0.03,   # 3% como decimal
             "iva_importacion_pct": 0.21,    # 21% como decimal
             "percepcion_iva_pct": 0.08,     # 8% como decimal
             "percepcion_ganancias_pct": 0.05, # 5% como decimal
             "ingresos_brutos_pct": 0.02,    # 2% como decimal
            "costo_flete_unitario": 5.0,
            "honorarios_despachante": 500,
            "ncm": "8517.12.00",
            "descripcion_ncm": "Tel√©fonos m√≥viles",
            "confianza_ia": "90%",
            "peso_unitario_kg": 0.2,
            "dimensiones": "15 √ó 7 √ó 1 cm",
            "metodo_flete": "A√©reo",
            "origen": "China",
            "destino": "Argentina",
            "tipo_importador": "Habitual",
            "provincia": "Buenos Aires",
            "notas": "Test de f√≥rmulas autom√°ticas"
        }
        
        print("üìä Ejecutando upload_to_google_sheets...")
        result = upload_to_google_sheets(test_data)
        
        if result:
            print("\nüéâ ¬°√âXITO! Upload completado con f√≥rmulas")
            print("üìã Ve tu Google Sheets para verificar:")
            print("  ‚Ä¢ Subtotal FOB = Cantidad √ó Precio")
            print("  ‚Ä¢ Impuestos calculados autom√°ticamente")
            print("  ‚Ä¢ Total Landed Cost din√°mico")
            print("  ‚Ä¢ Status visual con emojis")
            print("  ‚Ä¢ ROI y alertas")
        else:
            print("\n‚ùå Error en upload")
            
        return result
        
    except Exception as e:
        print(f"‚ùå Error: {e}")
        return False

if __name__ == "__main__":
    print("=" * 70)
    print("üß™ PRUEBA DE GOOGLE SHEETS Y F√ìRMULAS AUTOM√ÅTICAS")
    print("=" * 70)
    
    # Test b√°sico de conexi√≥n
    success_basic = test_google_sheets()
    
    if success_basic:
        print("\n" + "=" * 70)
        print("üöÄ TEST SIMPLE DE UPLOAD CON F√ìRMULAS")
        print("=" * 70)
        
        # Test simple de upload
        success_simple = test_simple_upload()
        
        if success_simple:
            print("\n" + "=" * 70)
            print("‚úÖ ¬°PERFECTO! F√≥rmulas autom√°ticas funcionando")
            print("üìä Revisa tu Google Sheets para ver:")
            print("  üßÆ C√°lculos autom√°ticos")
            print("  üí∞ Formato de moneda aplicado")
            print("  üìä Status y alertas visuales")
            print("  üîÑ F√≥rmulas din√°micas")
            print("\nüöÄ Tu aplicaci√≥n est√° lista:")
            print("streamlit run streamlit_ai_comercio_exterior.py")
            print("=" * 70)
        else:
            print("\n" + "=" * 70)
            print("‚ö†Ô∏è Problemas con f√≥rmulas - revisar implementaci√≥n")
            print("=" * 70)
    else:
        print("\n" + "=" * 70)
        print("‚ùå Problemas de conexi√≥n b√°sica")
        print("=" * 70) 